<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>What is PDI &mdash; Tempest  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/tempest.css?v=375db53c" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="https://wavedrom.com/skins/default.js"></script>
        <script src="https://wavedrom.com/wavedrom.min.js"></script>
        <script src="https://unpkg.com/mermaid@10.2.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Memory Map" href="memory.html" />
    <link rel="prev" title="Tempest JTAG-PDI RE project" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Tempest
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">What is PDI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-component-in-the-mcu">The component in the MCU</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-instruction-set">The instruction set</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#lds">LDS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ld">LD</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sts">STS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#st">ST</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ldcs">LDCS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#repeat">REPEAT</a></li>
<li class="toctree-l3"><a class="reference internal" href="#stcs">STCS</a></li>
<li class="toctree-l3"><a class="reference internal" href="#key">KEY</a></li>
<li class="toctree-l3"><a class="reference internal" href="#size-rules">Size Rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pointer-rules">Pointer Rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pdi-registers">PDI Registers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#status-register">Status Register</a></li>
<li class="toctree-l4"><a class="reference internal" href="#reset-register">Reset Register</a></li>
<li class="toctree-l4"><a class="reference internal" href="#control-register">Control Register</a></li>
<li class="toctree-l4"><a class="reference internal" href="#register-r3">Register r3</a></li>
<li class="toctree-l4"><a class="reference internal" href="#register-r4">Register r4</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#native-pdi-protocol">Native PDI protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="#jtag-pdi-protocol">JTAG-PDI protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-tap-instruction-register">The TAP instruction register</a></li>
<li class="toctree-l3"><a class="reference internal" href="#identification-ir-idcode">Identification (IR = IDCode)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pdi-mode-ir-pdi">PDI Mode (IR = PDI)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pdi-frame-format">PDI Frame Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="#the-conversation-a-worked-example">The conversation, a worked example</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="memory.html">Memory Map</a><ul>
<li class="toctree-l2"><a class="reference internal" href="memory.html#processor-controller">Processor Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory.html#breakpoint-unit">Breakpoint Unit</a></li>
<li class="toctree-l2"><a class="reference internal" href="memory.html#data-memory">Data Memory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="programming.html">Programming</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging/index.html">Debugging using PDI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="debugging/index.html#getting-started">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging/index.html#initiating-a-debug-session">Initiating a debug session</a><ul>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#put-the-processor-into-reset">Put the processor into reset</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#turn-the-debug-interface-on">Turn the debug interface on</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#take-the-reset-processor-and-put-it-in-debug-pause-state">Take the reset processor and put it in debug pause state</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="debugging/index.html#running-the-processor-to-an-address">Running the processor to an address</a><ul>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#set-up-run-to-address">Set up run-to-address</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#set-the-program-counter-to-a-specific-address">Set the program counter to a specific address</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#run-the-program-to-breakpoint">Run the program to breakpoint</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#clean-up">Clean up</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="debugging/index.html#reading-processor-state">Reading processor state</a><ul>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#read-program-counter-pc-1">Read program counter (PC+1)</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#clean-up-verification">Clean up verification</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#read-back-stack-pointer-sreg">Read back Stack Pointer + SREG</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#verify-state">Verify state</a></li>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#reading-back-the-avr-registers">Reading back the AVR registers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="debugging/index.html#single-stepping">Single Stepping</a><ul>
<li class="toctree-l3"><a class="reference internal" href="debugging/index.html#setting-up-the-breakpoint">Setting up the breakpoint</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="license.html">License</a><ul>
<li class="toctree-l2"><a class="reference internal" href="license.html#cc-by-sa-2-0">CC-BY-SA 2.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="contributors.html">Contributors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Tempest</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">What is PDI</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/pdi.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="what-is-pdi">
<h1>What is PDI<a class="headerlink" href="#what-is-pdi" title="Link to this heading"></a></h1>
<section id="the-component-in-the-mcu">
<h2>The component in the MCU<a class="headerlink" href="#the-component-in-the-mcu" title="Link to this heading"></a></h2>
<p>What if I told you that PDI was more than just a meer communications protocol? What if I told you that it was a
complex state machine, so complex in fact that it could nearly be mistaken for a processor.. Well, I would be
telling the truth.</p>
</section>
<section id="the-instruction-set">
<h2>The instruction set<a class="headerlink" href="#the-instruction-set" title="Link to this heading"></a></h2>
<p>All values transmitted as part of instructions and their effects are transmitted in LSB-first (Little Endian)
byte order.</p>
<section id="lds">
<h3>LDS<a class="headerlink" href="#lds" title="Link to this heading"></a></h3>
<p>The LDS instruction loads up to 4 bytes of data from a given direct address and sends it back to the host.
The opcode has the form:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "B", "bits": 2, "type": 2, "attr": "sizeB"},
		{"name": "A", "bits": 2, "type": 3, "attr": "sizeA"},
		{"name": 0, "bits": 1},
		{"name": 0x0, "bits": 3, "type": 4, "attr": "opcode (0x0)"},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<p>A and B follow the <a class="reference internal" href="#size-rules"><span class="xref myst">size rules</span></a> below.</p>
</section>
<section id="ld">
<h3>LD<a class="headerlink" href="#ld" title="Link to this heading"></a></h3>
<p>The LD instruction loads up to 4 bytes of data from the address given by the internal indirect addressing <code class="docutils literal notranslate"><span class="pre">ptr</span></code>
register which can only be read by this instruction.
The opcode has the form:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "B", "bits": 2, "type": 2, "attr": "sizeB"},
		{"name": "P", "bits": 2, "type": 5, "attr": "ptr mode"},
		{"name": 0, "bits": 1},
		{"name": 0x1, "bits": 3, "type": 4, "attr": "opcode (0x2)"},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<p>P defines an addressing form given by the <a class="reference internal" href="#pointer-rules"><span class="xref myst">pointer rules section</span></a> below.
B follows the <a class="reference internal" href="#size-rules"><span class="xref myst">size rules section</span></a> below.</p>
</section>
<section id="sts">
<h3>STS<a class="headerlink" href="#sts" title="Link to this heading"></a></h3>
<p>The STS instruction stores up to 4 bytes of data to a given direct address.
The opcode has the form:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "B", "bits": 2, "type": 2, "attr": "sizeB"},
		{"name": "A", "bits": 2, "type": 3, "attr": "sizeA"},
		{"name": 0, "bits": 1},
		{"name": 0x2, "bits": 3, "type": 4, "attr": "opcode (0x4)"},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<p>A and B follow the <a class="reference internal" href="#size-rules"><span class="xref myst">size rules</span></a> below.</p>
</section>
<section id="st">
<h3>ST<a class="headerlink" href="#st" title="Link to this heading"></a></h3>
<p>The ST instruction stores up to 4 bytes of data to the address given by the internal indirect addressing <code class="docutils literal notranslate"><span class="pre">ptr</span></code>
register which can only be directly written to by this instruction.
The opcode has the form:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "B", "bits": 2, "type": 2, "attr": "sizeB"},
		{"name": "P", "bits": 2, "type": 5, "attr": "ptr mode"},
		{"name": 0, "bits": 1},
		{"name": 0x3, "bits": 3, "type": 4, "attr": "opcode (0x6)"},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<p>P defines an addressing form given by the <a class="reference internal" href="#pointer-rules"><span class="xref myst">pointer rules section</span></a> below.
B follows the <a class="reference internal" href="#size-rules"><span class="xref myst">size rules section</span></a> below.</p>
</section>
<section id="ldcs">
<h3>LDCS<a class="headerlink" href="#ldcs" title="Link to this heading"></a></h3>
<p>The LDCS instruction allows reading of the PDI internal registers. PDI uses a 16-register stackless “CPU” (it’s not a
CPU but close enough for this). See <a class="reference internal" href="#pdi-registers"><span class="xref myst">PDI registers</span></a> below for more information on these registers.
They are encoded numerically in order in the bottom half of the instruction, which has the form:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "PDI register", "bits": 4, "type": 6, "attr": "parameter"},
		{"name": 0, "bits": 1},
		{"name": 0x4, "bits": 3, "type": 4, "attr": "opcode (0x8)"},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<p>The opcode’s parameter defines which register to read.</p>
</section>
<section id="repeat">
<h3>REPEAT<a class="headerlink" href="#repeat" title="Link to this heading"></a></h3>
<p>The REPEAT instruction specifies that the next instruction(!) is to be repeated N times after initial execution,
where N is specified in the bytes following this instruction.
The opcode has the following form:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "B", "bits": 2, "type": 2, "attr": "sizeB"},
		{"name": 0, "bits": 3},
		{"name": 0x5, "bits": 3, "type": 4, "attr": "opcode (0xa)"},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<p>B follows the <a class="reference internal" href="#size-rules"><span class="xref myst">size rules section</span></a> below and specifies how many bytes follow this instruction to
be 0-padded and loaded into the PDI repeat register</p>
</section>
<section id="stcs">
<h3>STCS<a class="headerlink" href="#stcs" title="Link to this heading"></a></h3>
<p>The STCS instruction allows writing to the PDI internal registsers. See <a class="reference internal" href="#pdi-registers"><span class="xref myst">PDI registers</span></a> below for
more information on these registers.
They are encoded numerically inorder in the bottom half of the instruction, which has the form:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "PDI register", "bits": 4, "type": 6, "attr": "parameter"},
		{"name": 0, "bits": 1},
		{"name": 0x6, "bits": 3, "type": 4, "attr": "opcode (0xc)"},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<p>The opcode’s parameter defines which register to write.</p>
</section>
<section id="key">
<h3>KEY<a class="headerlink" href="#key" title="Link to this heading"></a></h3>
<p>The KEY instruction is used to unlock special functions of the PDI controller.
The opcode has the following form:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": 0, "bits": 5},
		{"name": 0x7, "bits": 3, "type": 4, "attr": "opcode (0xe)"},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<p>8 bytes follow the key instruction and provide a special unlocking value for the feature you wish to unlock.
There are two known key value constants which are:</p>
<ul class="simple">
<li><p>NVM - <code class="docutils literal notranslate"><span class="pre">0x1289ab45cdd888ff</span></code></p></li>
<li><p>Debug - <code class="docutils literal notranslate"><span class="pre">0x3a212dd49f7c8121</span></code></p></li>
</ul>
<p>These are sent little endian and look like this on the wire:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"signal":
	[
		{
			"name": "clk",
			"wave": "P...................................................................................................",
			"phase": 0.5
		},
		{
			"name": "data",
			"wave": "103.......4103.......4103.......4103.......4103.......4103.......4103.......4103.......4103.......41",
			"data": ["ff", 0, "88", 0, "d8", 0, "cd", 1, "45", 1, "ab", 1, "89", 1, "12", 0]
		},
	],
	"config": {"hscale": 1}
}
</script>
</div>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"signal":
	[
		{
			"name": "clk",
			"wave": "P...................................................................................................",
			"phase": 0.5
		},
		{
			"name": "data",
			"wave": "103.......4103.......4103.......4103.......4103.......4103.......4103.......4103.......4103.......41",
			"data": ["21", 0, "81", 0, "7c", 1, "9f", 0, "d4", 0, "2d", 0, "21", 0, "3a", 0]
		},
	],
	"config": {"hscale": 1}
}
</script>
</div>
</section>
<section id="size-rules">
<h3>Size Rules<a class="headerlink" href="#size-rules" title="Link to this heading"></a></h3>
<p>There are two size types (A and B) in the official protocol documentation.. however, they’re identical so we
only document them once here. A is always used for address length encoding, and B for data.</p>
<p>The 2-bit value defines the number of bytes that follow the instruction for the specific type of value following.
When present the A value is transmitted first, then the B.</p>
<p>The following table defines the possible bit values and their meanings:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p>Value</p></th>
<th class="head text-left"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>0 0</p></td>
<td class="text-left"><p>1 byte</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0 1</p></td>
<td class="text-left"><p>2 bytes</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>1 0</p></td>
<td class="text-left"><p>3 bytes</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>1 1</p></td>
<td class="text-left"><p>4 bytes</p></td>
</tr>
</tbody>
</table>
</section>
<section id="pointer-rules">
<h3>Pointer Rules<a class="headerlink" href="#pointer-rules" title="Link to this heading"></a></h3>
<p>The pointer register and all access for it are encoded in the LD and ST instructions with the following form:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p>Value</p></th>
<th class="head text-left"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>0 0</p></td>
<td class="text-left"><p>*ptr</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0 1</p></td>
<td class="text-left"><p>*(ptr++)</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>1 0</p></td>
<td class="text-left"><p>ptr</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>1 1</p></td>
<td class="text-left"><p>ptr++ (reserved)</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The pointer register is written to by all direct addressing instructions which is undocumented by the datasheets and
has a profound impact on the instruction ordering that must be kept.</p>
</div>
</section>
<section id="pdi-registers">
<h3>PDI Registers<a class="headerlink" href="#pdi-registers" title="Link to this heading"></a></h3>
<p>The PDI “CPU” has 16 internal 8-bit registers.
Some of these are documented, others are “reserved” (they may actually be unused, but it’s unclear at this time if
they are or if they’re not just additional special-function CSRs).
All of these registers are CSRs that define status for and control how debug and programming will run.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p>Register#</p></th>
<th class="head text-left"><p>Alias</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>0 0 0 0</p></td>
<td class="text-left"><p>status</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0 0 0 1</p></td>
<td class="text-left"><p>reset</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>0 0 1 0</p></td>
<td class="text-left"><p>control</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0 0 1 1</p></td>
<td class="text-left"><p>r3</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>0 1 0 0</p></td>
<td class="text-left"><p>r4</p></td>
</tr>
</tbody>
</table>
<p>The rest are “reserved”.</p>
<section id="status-register">
<h4>Status Register<a class="headerlink" href="#status-register" title="Link to this heading"></a></h4>
<p>The status register’s bits have the following meanings assigned to them:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "-", "bits": 1, "attr": ["R", "0"]},
		{"name": "NVMEN", "bits": 1, "attr": ["R/W", "0"]},
		{"name": "DBGEN", "bits": 1, "attr": ["R/W", "0"]},
		{"name": "-", "bits": 5, "attr": ["R", "0"]},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<p>The bottom row defines the reset state of this register.</p>
<ul class="simple">
<li><p>NVMEN is the Flash/EEPROM Non-Voltile Memory access enable</p></li>
<li><p>DBGEN is the debugger PDI component enable</p></li>
</ul>
<p>These bits cannot be written high - this operation is acomplished using the key instruction.
Writing a 0 to an enable bit disables that specific function, writing a 1 preserves its current state.</p>
</section>
<section id="reset-register">
<h4>Reset Register<a class="headerlink" href="#reset-register" title="Link to this heading"></a></h4>
<p>The reset register is both a control and status register. It has two meanings.</p>
<p>As a control register (write) it means:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "RESET", "bits": 8, "attr": ["R/W", "0"]},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<p>As a status register (read) it means:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "RESET", "bits": 1, "attr": ["R/W", "0"]},
		{"name": "-", "bits": 7, "attr": ["R", "0"]},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<p>Writing 0x59 to this register puts the main processor into reset as if asserting the ~RESET pin,
with a caviat as given below.
Writing to a value other than this (such as 0) takes the device back out of reset.</p>
<p>When DBGEN is 1 in the status register, the operation of this register is modified to, instead of causing a full reset,
only cause a device halt. This is how pause/resume is acomplished in combination with r3/r4.
When not held in reset-pause by this register, it is still possible for the main CPU to not be running as a result of
r3/r4 state. This is covered in their documentation sections.</p>
</section>
<section id="control-register">
<h4>Control Register<a class="headerlink" href="#control-register" title="Link to this heading"></a></h4>
<p>This control register is used to control turn-around timings for the <a class="reference internal" href="#native-pdi-protocol"><span class="xref myst">native physical protocol</span></a>.
The register’s bits have the following meanings assigned to them:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "GUARDTIME", "bits": 3, "attr": ["R/W", "0"]},
		{"name": "-", "bits": 5, "attr": ["R", "0"]},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<ul class="simple">
<li><p>GUARDTIME specifies the number of idle bits of guard time inserted between PDI RX and TX direction changes.
It defaults to 128 bits, and what the bits mean is determined by the table below:</p></li>
</ul>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p>GUARDTIME</p></th>
<th class="head text-left"><p>number of idle bits</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>0 0 0</p></td>
<td class="text-left"><p>128</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0 0 1</p></td>
<td class="text-left"><p>64</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>0 1 0</p></td>
<td class="text-left"><p>32</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0 1 1</p></td>
<td class="text-left"><p>16</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>1 0 0</p></td>
<td class="text-left"><p>8</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>1 0 1</p></td>
<td class="text-left"><p>4</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>1 1 0</p></td>
<td class="text-left"><p>2</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>1 1 1</p></td>
<td class="text-left"><p>2</p></td>
</tr>
</tbody>
</table>
</section>
<section id="register-r3">
<h4>Register r3<a class="headerlink" href="#register-r3" title="Link to this heading"></a></h4>
<p>This status regsiter indicates the current state of the debug engine when enabled (otherwise it reads as 0)</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "-", "bits": 3, "attr": ["R", "0"]},
		{"name": "PAUSE", "bits": 1, "attr": ["R", "0"]},
		{"name": "RESET", "bits": 1, "attr": ["R", "0"]},
		{"name": "-", "bits": 3, "attr": ["R", "0"]},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
<ul class="simple">
<li><p>The RESET bit indicates whether the processor is currently held in reset and is sort-of a duplicate of the RESET
bit from the reset CSR.</p></li>
<li><p>The PAUSE bit indicates whether the processor is currently held in execution pause.</p></li>
</ul>
</section>
<section id="register-r4">
<h4>Register r4<a class="headerlink" href="#register-r4" title="Link to this heading"></a></h4>
<p>This control register determines whether the debug engine is enabled</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": "ENABLE", "bits": 1, "attr": ["R/W", "0"]},
		{"name": "-", "bits": 7, "attr": ["R", "0"]},
	],
	"config": {"hspace": 500, "bits": 8}
}
</script>
</div>
</section>
</section>
</section>
<section id="native-pdi-protocol">
<h2>Native PDI protocol<a class="headerlink" href="#native-pdi-protocol" title="Link to this heading"></a></h2>
</section>
<section id="jtag-pdi-protocol">
<h2>JTAG-PDI protocol<a class="headerlink" href="#jtag-pdi-protocol" title="Link to this heading"></a></h2>
<p>This section assumes exiting basic working knowledge of the JTAG standard (IEEE 1149.1-2013). This will only cover
how the protocol works with the TAP and sits above it.</p>
<p>The JTAG-encapsulated form of PDI is rather interesting in construction as it consists of a few elements, some of
which caused by taking a half-duplex, single-data-wire bi-directional protocol with turn-arounds and re-mapping it
to a full-duplex comms protocol. The first of the elements is how ID’ing the device works, the second is entering PDI
mode, and the third is the encapsulation of the PDI data.</p>
<section id="the-tap-instruction-register">
<h3>The TAP instruction register<a class="headerlink" href="#the-tap-instruction-register" title="Link to this heading"></a></h3>
<p>On all Atmel devices implementing JTAG-PDI, the IR is 4 bits wide and defines the following instructions:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p>IR Code</p></th>
<th class="head text-left"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>0x0</p></td>
<td class="text-left"><p>Unassigned</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0x1</p></td>
<td class="text-left"><p>External Test</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>0x2</p></td>
<td class="text-left"><p>Sample/Pre-load</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0x3</p></td>
<td class="text-left"><p>IDCode</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>0x4</p></td>
<td class="text-left"><p>Clamp</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0x5</p></td>
<td class="text-left"><p>High-Z</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>0x6</p></td>
<td class="text-left"><p>Unassigned</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0x7</p></td>
<td class="text-left"><p>PDI Comms</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>0x8</p></td>
<td class="text-left"><p>Unassigned</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0xA</p></td>
<td class="text-left"><p>Unassigned</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>0xB</p></td>
<td class="text-left"><p>Unassigned</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0xC</p></td>
<td class="text-left"><p>Unassigned</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>0xD</p></td>
<td class="text-left"><p>Unassigned</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0xE</p></td>
<td class="text-left"><p>Unassigned</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>0xF</p></td>
<td class="text-left"><p>Bypass</p></td>
</tr>
</tbody>
</table>
<p>Of this table, we only really care about 3 instructions - IDCode (0x3), PDI (0x7), and Bypass (0xF).
The device when TAP reset, enters IDCode by default.</p>
</section>
<section id="identification-ir-idcode">
<h3>Identification (IR = IDCode)<a class="headerlink" href="#identification-ir-idcode" title="Link to this heading"></a></h3>
<p>The first thing to do when starting a conversation over JTAG is to perform an IDCode to find out what the part is.
With the TAP IR loaded with IDCode, we then expect a value in the following format to be read:</p>

<div style="overflow-x:auto">
<script type="WaveDrom">
{
	"reg":
	[
		{"name": 1, "bits": 1},
		{"name": "Manufacturer ID", "bits": 11},
		{"name": "Part Number", "bits": 16},
		{"name": "Version", "bits": 4},
	],
	"config": {"hspace": 675, "bits": 32}
}
</script>
</div>
<p>Bit 0 listed here is the constant 1.</p>
<p>The following are a list of known values and the chips they belong to:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p>ID Code</p></th>
<th class="head text-left"><p>Part Number</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>0x6964203F</p></td>
<td class="text-left"><p>ATXMega64A3U</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0x6974203F</p></td>
<td class="text-left"><p>ATXMega128A3U</p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>0x6974403F</p></td>
<td class="text-left"><p>ATXMega192A3U</p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>0x6984203F</p></td>
<td class="text-left"><p>ATXMega256A3U</p></td>
</tr>
</tbody>
</table>
</section>
<section id="pdi-mode-ir-pdi">
<h3>PDI Mode (IR = PDI)<a class="headerlink" href="#pdi-mode-ir-pdi" title="Link to this heading"></a></h3>
<p>Once you have identified a device and confirmed it definitely implements PDI, issue the PDI Comms instruction to the
TAP. This will (until touching IR again) enter PDI mode and drop the TAP into JTAG-PDI mode. From here on in, you can
ignore the TAP completely save for clocking data in and out of the 9-bit register that is now connected between TDI
and TDO.</p>
<p>Of importance to note, the PDI register in the Atmel literature is talked about as if it’s a single shift-register
between TDI and TDO, however it it may be helpful to think of it as more like two seperate shift registers - one
connected to TDI and one to TDO  - for the purpose of the exchanges had.</p>
<section id="pdi-frame-format">
<h4>PDI Frame Format<a class="headerlink" href="#pdi-frame-format" title="Link to this heading"></a></h4>
<p>PDI data entering and leaving the PDI TAP register has the following format:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head text-center"><p>LSB</p></th>
<th class="head text-center"><p></p></th>
<th class="head text-center"><p></p></th>
<th class="head text-center"><p></p></th>
<th class="head text-center"><p></p></th>
<th class="head text-center"><p></p></th>
<th class="head text-center"><p></p></th>
<th class="head text-center"><p></p></th>
<th class="head text-center"><p>MSB</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>0</p></td>
<td class="text-center"><p>1</p></td>
<td class="text-center"><p>2</p></td>
<td class="text-center"><p>3</p></td>
<td class="text-center"><p>4</p></td>
<td class="text-center"><p>5</p></td>
<td class="text-center"><p>6</p></td>
<td class="text-center"><p>7</p></td>
<td class="text-center"><p>P</p></td>
</tr>
</tbody>
</table>
<p>This is sent LSB first.</p>
<p>This encapsulation defines 3 special character values of note to emulate certain aspects of the native protocol and
handle that this is full-duplex comms:</p>
<ul class="simple">
<li><p>the Break character: 0xBB + P1</p></li>
<li><p>the Delay character: 0xDB + P1</p></li>
<li><p>the Empty character: 0xEB + P1</p></li>
</ul>
<p>“+ P1” in the above refers to the parity bit being set to generate a parity error.
The bit transitions for communications to TDI must be performed on the TCK falling edge, and TDO sampled on the rising.</p>
</section>
<section id="the-conversation-a-worked-example">
<h4>The conversation, a worked example<a class="headerlink" href="#the-conversation-a-worked-example" title="Link to this heading"></a></h4>
<p>JTAG-PDI does two important things to handle being a full-duplex protocol, the first is that the <strong>target’s controller</strong>
will send Empty characters while waiting for more imput and and the <strong>programmer</strong> must use the NUL byte as a dummy
character when expecting the target to send data back. It is important that the programmer not generate parity errors
as this triggers a PDI transaction abort.</p>
<p>In practice this looks a bit like:</p>
<div class="mermaid">
            sequenceDiagram
	participant Programmer
	participant Target
	Programmer--&gt;&gt;Target: LDCS status, m1
	Target--&gt;&gt;Programmer: EMPTY
	Note right of Target: These happen simultaneously&lt;br /&gt;with the reply on TDO&lt;br /&gt;as you send the request on TDI
	Programmer-&gt;&gt;Target: DUMMY (0x00)
	Target--&gt;&gt;Programmer: 0x00
        </div><p>In this example, we ask the target for its PDI status, and get the answer ‘0’
(neither programming nor debug mode enabled).</p>
</section>
</section>
</section>
</section>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Tempest JTAG-PDI RE project" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="memory.html" class="btn btn-neutral float-right" title="Memory Map" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, 2024, Tempest Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>