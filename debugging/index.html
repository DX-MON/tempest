<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debugging using PDI &mdash; Tempest  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/tempest.css?v=72f08876" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="https://wavedrom.com/skins/default.js"></script>
        <script src="https://wavedrom.com/wavedrom.min.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="License" href="../license.html" />
    <link rel="prev" title="Programming" href="../programming.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Tempest
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../pdi.html">What is PDI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../pdi.html#the-component-in-the-mcu">The component in the MCU</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pdi.html#the-instruction-set">The instruction set</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#lds">LDS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#ld">LD</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#sts">STS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#st">ST</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#ldcs">LDCS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#repeat">REPEAT</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#stcs">STCS</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#key">KEY</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#size-rules">Size Rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#pointer-rules">Pointer Rules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#pdi-registers">PDI Registers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../pdi.html#status-register">Status Register</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pdi.html#reset-register">Reset Register</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pdi.html#control-register">Control Register</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pdi.html#register-r3">Register r3</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pdi.html#register-r4">Register r4</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../pdi.html#native-pdi-protocol">Native PDI protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="../pdi.html#jtag-pdi-protocol">JTAG-PDI protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#the-tap-instruction-register">The TAP instruction register</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#identification-ir-idcode">Identification (IR = IDCode)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../pdi.html#pdi-mode-ir-pdi">PDI Mode (IR = PDI)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../pdi.html#pdi-frame-format">PDI Frame Format</a></li>
<li class="toctree-l4"><a class="reference internal" href="../pdi.html#the-conversation-a-worked-example">The conversation, a worked example</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../memory.html">Memory Map</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../memory.html#processor-controller">Processor Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory.html#breakpoint-unit">Breakpoint Unit</a></li>
<li class="toctree-l2"><a class="reference internal" href="../memory.html#data-memory">Data Memory</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../programming.html">Programming</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Debugging using PDI</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#getting-started">Getting started</a></li>
<li class="toctree-l2"><a class="reference internal" href="#initiating-a-debug-session">Initiating a debug session</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#put-the-processor-into-reset">Put the processor into reset</a></li>
<li class="toctree-l3"><a class="reference internal" href="#turn-the-debug-interface-on">Turn the debug interface on</a></li>
<li class="toctree-l3"><a class="reference internal" href="#take-the-reset-processor-and-put-it-in-debug-pause-state">Take the reset processor and put it in debug pause state</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#running-the-processor-to-an-address">Running the processor to an address</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#set-up-run-to-address">Set up run-to-address</a></li>
<li class="toctree-l3"><a class="reference internal" href="#set-the-program-counter-to-a-specific-address">Set the program counter to a specific address</a></li>
<li class="toctree-l3"><a class="reference internal" href="#run-the-program-to-breakpoint">Run the program to breakpoint</a></li>
<li class="toctree-l3"><a class="reference internal" href="#clean-up">Clean up</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#reading-processor-state">Reading processor state</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#read-program-counter-pc-1">Read program counter (PC+1)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#clean-up-verification">Clean up verification</a></li>
<li class="toctree-l3"><a class="reference internal" href="#read-back-stack-pointer-sreg">Read back Stack Pointer + SREG</a></li>
<li class="toctree-l3"><a class="reference internal" href="#verify-state">Verify state</a></li>
<li class="toctree-l3"><a class="reference internal" href="#reading-back-the-avr-registers">Reading back the AVR registers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#single-stepping">Single Stepping</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-up-the-breakpoint">Setting up the breakpoint</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../license.html">License</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../license.html#cc-by-sa-2-0">CC-BY-SA 2.0</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../contributors.html">Contributors</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Tempest</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Debugging using PDI</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/debugging/index.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="debugging-using-pdi">
<h1>Debugging using PDI<a class="headerlink" href="#debugging-using-pdi" title="Link to this heading"></a></h1>
<section id="getting-started">
<h2>Getting started<a class="headerlink" href="#getting-started" title="Link to this heading"></a></h2>
<p>Debug has its own key value that must be sent to enable it. You can check if this needs doing by issuing <code class="docutils literal notranslate"><span class="pre">ldcs</span> <span class="pre">status</span></code> to the PDI processor.</p>
<p>The debug key uses the constant 0x3a212dd49f7c8121 to unlock the debug part of the controller.</p>
</section>
<section id="initiating-a-debug-session">
<h2>Initiating a debug session<a class="headerlink" href="#initiating-a-debug-session" title="Link to this heading"></a></h2>
<section id="put-the-processor-into-reset">
<h3>Put the processor into reset<a class="headerlink" href="#put-the-processor-into-reset" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>stcs reset 0x59
ldcs status
</pre></div>
</div>
<p>The LDCS should return 0x00 if these are the first instructions run in a session.</p>
</section>
<section id="turn-the-debug-interface-on">
<h3>Turn the debug interface on<a class="headerlink" href="#turn-the-debug-interface-on" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>key debug
ldcs status
</pre></div>
</div>
<p>The LDCS should return 0x04 if <code class="docutils literal notranslate"><span class="pre">key</span> <span class="pre">nvm</span></code> has not been run yet, and 0x06 if it has.</p>
</section>
<section id="take-the-reset-processor-and-put-it-in-debug-pause-state">
<h3>Take the reset processor and put it in debug pause state<a class="headerlink" href="#take-the-reset-processor-and-put-it-in-debug-pause-state" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>stcs r4 1
ldcs r3
stcs reset 0x00
ldcs r3
ldcs r3
</pre></div>
</div>
<p>Writing bit 1 of r4 puts the processor into debug-based pause once reset is released
the first LDCS to r3 is used to verify that r3 is presently 0x10 (processor held in reset, debugging not active).
Once reset is released, r3 will initially be 0x14, which should be observed with the second LDCS.
Once debug setup is completed, r4 will then read as 0x04, which should be observed with the final LDCS.</p>
</section>
</section>
<section id="running-the-processor-to-an-address">
<h2>Running the processor to an address<a class="headerlink" href="#running-the-processor-to-an-address" title="Link to this heading"></a></h2>
<p>The following uses the hardware breakpoint unit, which contains 2 breakpoint address registers and associated
control machinery.</p>
<section id="set-up-run-to-address">
<h3>Set up run-to-address<a class="headerlink" href="#set-up-run-to-address" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>sts.u32 0x00000020 0x29 0x01 0x00 0x00
sts.u32 0x00000024 0x00 0x00 0x00 0x00
sts.u8 0x00000040 0x00
sts.u8 0x00000040 0x00
sts.u16 0x00000028 0x00 0x01
sts.u8 0x00000048 0x00
</pre></div>
</div>
<p>This sequence performs the following operations (some of them need more figuring out how things work to understand):</p>
<ul class="simple">
<li><p>Stores 0x00000129 (as the target program address to run the processor to) into the hardware breakpoint unit’s
first break address register at 0x00000020. Program addresses are in words which is why they are half what
they should be going by <code class="docutils literal notranslate"><span class="pre">objdump</span></code> output.</p></li>
<li><p>Stores 0x00000000 to the hardware breakpoint unit’s second break address register at 0x00000024</p></li>
<li><p>Stores 0x00 to a byte register at 0x00000040 (twice) - the purpose for this is not well understood yet and is
essential to the proper functioning of the breakpoint unit. Without this, the unit will not engage correctly.</p></li>
<li><p>Stores 0x0100 to the hardware breakpoint unit’s breakpoint counter and configuration (16-bit) register at 0x00000028</p></li>
<li><p>Stores 0x00 to a byte register at 0x00000048 - the purpose for this is not well understood yet and is
essential to the proper functioning of the breakpoint unit. Without this, the unit will not engage correctly.</p></li>
</ul>
</section>
<section id="set-the-program-counter-to-a-specific-address">
<h3>Set the program counter to a specific address<a class="headerlink" href="#set-the-program-counter-to-a-specific-address" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>sts.u32 0x00000004 0x00 0x00 0x00 0x00
</pre></div>
</div>
<p>This writes the program counter, exposed at 0x00000004, to its POR value</p>
</section>
<section id="run-the-program-to-breakpoint">
<h3>Run the program to breakpoint<a class="headerlink" href="#run-the-program-to-breakpoint" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>stcs reset 0x00
sts.u8 0x0000000a 0x00
stcs r4 0x01
ldcs r3
ldcs r3
</pre></div>
</div>
<p>This sequence does the following:</p>
<ul class="simple">
<li><p>With r4 poked, releases reset so that at this stage enters the processor into a debugger-supervised state</p></li>
<li><p>Stores 0x00 to the debug register 0x0000000a which appears to arm the processor resuming execution</p></li>
<li><p>Ensures r4 holds the value 0x01 which ensures we stay in debugger-supervised state is set</p></li>
<li><p>Loads the status of the processor from r3 (should read as 0x14 the first time)</p></li>
<li><p>Loads the status of the processor again (should read as 0x04 the second time indicating the breakpoint is hit)</p></li>
</ul>
</section>
<section id="clean-up">
<h3>Clean up<a class="headerlink" href="#clean-up" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>sts.u16 0x00000028 0x00 0x00
sts.u8 0x00000048 0x00
</pre></div>
</div>
<p>Cleans up after the debug run by clearing all set breakpoints by setting the control and counter value to 0</p>
</section>
</section>
<section id="reading-processor-state">
<h2>Reading processor state<a class="headerlink" href="#reading-processor-state" title="Link to this heading"></a></h2>
<section id="read-program-counter-pc-1">
<h3>Read program counter (PC+1)<a class="headerlink" href="#read-program-counter-pc-1" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>lds.u32 0x00000004
</pre></div>
</div>
<p>Reads the program counter from its fixed register address of 0x00000004</p>
</section>
<section id="clean-up-verification">
<h3>Clean up verification<a class="headerlink" href="#clean-up-verification" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>lds.u8 0x00000050
lds.u8 0x0000000b
</pre></div>
</div>
<p>Reads an unknown special register in the breakpoint unit and the upper half of the control register</p>
</section>
<section id="read-back-stack-pointer-sreg">
<h3>Read back Stack Pointer + SREG<a class="headerlink" href="#read-back-stack-pointer-sreg" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>st.u32 ptr 0x0100003d
repeat 0x02
ld *(ptr++)
</pre></div>
</div>
<p>Directly reads from the PDI bus location for the SPL, SPH and SREG registers in peripheral space</p>
</section>
<section id="verify-state">
<h3>Verify state<a class="headerlink" href="#verify-state" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>ldcs r3
lds.u8 0x010001ca
lds.u8 0x010001c4
</pre></div>
</div>
<p>Verify that the NVM controller in peripheral space is in an idle state</p>
</section>
<section id="reading-back-the-avr-registers">
<h3>Reading back the AVR registers<a class="headerlink" href="#reading-back-the-avr-registers" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>sts.u32 0x00000004 0x00 0x00 0x00 0x00
sts.u8 0x0000000a 0x11
sts.u32 0x00000000 0x20 0x00 0x00 0x00
stcs r4 1
st ptr 0x0000000c
repeat 31
ld *ptr
</pre></div>
</div>
<p>This sequence does the following:</p>
<ul class="simple">
<li><p>Sets the program counter to 0x0 (is this actually necessary?)</p></li>
<li><p>Loads the debug control register with special value 0x11 which turns the multifunction register into a read counter</p></li>
<li><p>Loads the multifunction register (now a read counter) with the number of registers to read (32)</p></li>
<li><p>Tells the PDI part of the debug controller to exec the action (STCS to r4)</p></li>
<li><p>Loads the PDI pointer register with the address of the I/O FIFO (0x0000000c)</p></li>
<li><p>Tells the PDI controller to repeat for the number of AVR registers minus 1 (due to how the repeat register works,
this makes the load run 32 times)</p></li>
<li><p>Reads the registers back from the read FIFO (r0..r31)</p></li>
</ul>
</section>
</section>
<section id="single-stepping">
<h2>Single Stepping<a class="headerlink" href="#single-stepping" title="Link to this heading"></a></h2>
<p>The debug control system has a tempory (single-stepping) breakpoint available too which can be used to implement one-use breakpoints without touching the main two.</p>
<section id="setting-up-the-breakpoint">
<h3>Setting up the breakpoint<a class="headerlink" href="#setting-up-the-breakpoint" title="Link to this heading"></a></h3>
<div class="highlight-pdi notranslate"><div class="highlight"><pre><span></span>sts.u8 0x0000000a 0x04
sts.u32 0x00000000 0x55 0x03 0x00 0x00
sts.u32 0x00000004 0x54 0x03 0x00 0x00
</pre></div>
</div>
<p>This sequence does the following:</p>
<ul class="simple">
<li><p>Loads the debug control register with special value 0x04 which turns the multifunction register into a temporary breakpoint</p></li>
<li><p>Loads the now breakpoint register with the address to break on (0x0355 in this example)</p></li>
<li><p>Loads the program counter with the resumption address (0x0354 in this address, making this a single-step run)</p></li>
</ul>
</section>
</section>
</section>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../programming.html" class="btn btn-neutral float-left" title="Programming" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../license.html" class="btn btn-neutral float-right" title="License" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, 2024, Tempest Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>